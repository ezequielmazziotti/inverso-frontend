<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inverso ‚Äî An√°lisis de activos con IA</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0e13;--surface:#13171f;--surface2:#1a1f2b;--border:#1e2530;
  --accent:#c9a96e;--accent-dim:rgba(201,169,110,0.12);--accent-border:rgba(201,169,110,0.25);
  --text:#e8e4dc;--muted:#7a8394;--green:#4caf82;--red:#e05a5a;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-weight:300;line-height:1.6;overflow-x:hidden}
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;height:100vh;z-index:50;transition:transform 0.3s}
.main{margin-left:220px;flex:1;min-height:100vh}
.sidebar-logo{padding:1.75rem 1.5rem 1.25rem;border-bottom:1px solid var(--border)}
.logo-text{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:700;color:var(--accent)}
.logo-text span{color:var(--text)}
.logo-sub{font-size:0.7rem;color:var(--muted);letter-spacing:0.08em;text-transform:uppercase;margin-top:0.2rem}
.sidebar-nav{padding:1rem 0;flex:1}
.nav-section-label{font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);padding:0.5rem 1.5rem 0.3rem}
.nav-item{display:flex;align-items:center;gap:0.75rem;padding:0.65rem 1.5rem;cursor:pointer;color:var(--muted);font-size:0.875rem;transition:all 0.2s;border-left:2px solid transparent;text-decoration:none}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,0.03)}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:var(--accent-dim)}
.nav-icon{font-size:1rem;width:20px;text-align:center}
.sidebar-bottom{padding:1rem 1.5rem;border-top:1px solid var(--border)}
.plan-badge{background:var(--accent-dim);border:1px solid var(--accent-border);border-radius:6px;padding:0.5rem 0.75rem;text-align:center}
.plan-badge .plan-name{font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--accent)}
.plan-badge .plan-analyses{font-size:0.75rem;color:var(--muted);margin-top:0.1rem}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40}
.topbar-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:600}
.avatar{width:32px;height:32px;border-radius:50%;background:var(--accent-dim);border:1px solid var(--accent-border);display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--accent);cursor:pointer}
.page{display:none;padding:2rem}
.page.active{display:block}
.search-hero{text-align:center;padding:3rem 1rem 2rem}
.search-hero h1{font-family:'Playfair Display',serif;font-size:2rem;margin-bottom:0.5rem}
.search-hero p{color:var(--muted);font-size:0.9rem;margin-bottom:2rem}
.search-box{position:relative;max-width:560px;margin:0 auto}
.search-input{width:100%;padding:1rem 1.25rem 1rem 3rem;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:1rem;outline:none;transition:border-color 0.2s}
.search-input:focus{border-color:var(--accent-border);box-shadow:0 0 0 3px var(--accent-dim)}
.search-input::placeholder{color:var(--muted)}
.search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--muted);font-size:1.1rem}
.search-suggestions{position:absolute;top:100%;left:0;right:0;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;z-index:100;display:none}
.search-suggestions.open{display:block}
.suggestion-item{padding:0.75rem 1.25rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background 0.15s}
.suggestion-item:hover{background:rgba(255,255,255,0.04)}
.sug-ticker{font-size:0.9rem;font-weight:500;color:var(--text)}
.sug-name{font-size:0.75rem;color:var(--muted)}
.quick-label{font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);text-align:center;margin:1.5rem 0 0.75rem}
.quick-chips{display:flex;flex-wrap:wrap;gap:0.5rem;justify-content:center;max-width:560px;margin:0 auto}
.chip{padding:0.4rem 0.9rem;background:var(--surface);border:1px solid var(--border);border-radius:100px;font-size:0.8rem;cursor:pointer;color:var(--muted);transition:all 0.2s}
.chip:hover{border-color:var(--accent-border);color:var(--accent)}
.market-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:2rem}
.market-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.25rem}
.mc-label{font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:0.5rem}
.mc-value{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:600}
.mc-change{font-size:0.8rem;margin-top:0.2rem}
.mc-change.up{color:var(--green)}
.mc-change.down{color:var(--red)}
.analysis-header{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
.ah-ticker{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700}
.ah-name{font-size:0.85rem;color:var(--muted)}
.ah-price{font-family:'Playfair Display',serif;font-size:1.8rem}
.ah-change{font-size:0.9rem}
.ah-change.up{color:var(--green)}
.ah-change.down{color:var(--red)}
.analysis-grid{display:grid;grid-template-columns:1fr 2fr;gap:1.5rem;margin-bottom:1.5rem}
@media(max-width:700px){.analysis-grid{grid-template-columns:1fr}}
.score-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.75rem;display:flex;flex-direction:column;align-items:center;text-align:center;gap:1rem}
.score-ring{position:relative;width:120px;height:120px}
.score-ring svg{transform:rotate(-90deg)}
.score-ring circle{transition:stroke-dashoffset 1s ease}
.score-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center}
.score-num{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:var(--accent);line-height:1}
.score-den{font-size:0.7rem;color:var(--muted)}
.score-label-text{font-size:0.75rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted)}
.score-desc{font-size:0.85rem;color:var(--muted);line-height:1.6}
.factors-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem}
.factors-title{font-size:0.75rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem}
.factor-item{display:flex;align-items:flex-start;gap:0.75rem;padding:0.85rem 0;border-bottom:1px solid var(--border)}
.factor-item:last-child{border-bottom:none;padding-bottom:0}
.factor-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:0.35rem}
.factor-dot.pos{background:var(--green)}
.factor-dot.neg{background:var(--red)}
.factor-dot.neu{background:var(--accent)}
.factor-name{font-size:0.82rem;font-weight:500;margin-bottom:0.2rem}
.factor-desc{font-size:0.78rem;color:var(--muted);line-height:1.5}
.mep-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.card-title{font-size:0.75rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:1rem}
.mep-table{width:100%;border-collapse:collapse}
.mep-table th{font-size:0.75rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);padding:0.5rem 0.75rem;text-align:left;border-bottom:1px solid var(--border)}
.mep-table td{padding:0.65rem 0.75rem;font-size:0.875rem;border-bottom:1px solid rgba(30,37,48,0.5)}
.mep-table td:first-child{color:var(--muted);font-size:0.8rem}
.pos-val{color:var(--green)}
.neg-val{color:var(--red)}
.summary-card{background:var(--surface);border:1px solid var(--border);border-left:3px solid var(--accent);border-radius:0 12px 12px 0;padding:1.5rem;margin-bottom:1.5rem}
.btn{padding:0.7rem 1.5rem;border-radius:8px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.875rem;font-weight:500;transition:all 0.2s}
.btn-accent{background:var(--accent);color:#0b0e13}
.btn-accent:hover{background:#d9bc87}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-outline:hover{border-color:var(--accent-border);color:var(--accent)}
.btn-row{display:flex;gap:0.75rem;flex-wrap:wrap}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.chart-wrapper{height:240px;margin-top:1rem}
.projections-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
@media(max-width:600px){.projections-grid{grid-template-columns:1fr}}
.proj-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.25rem}
.proj-horizon{font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--accent);margin-bottom:0.75rem}
.proj-scenario{display:flex;justify-content:space-between;align-items:center;padding:0.4rem 0;border-bottom:1px solid var(--border);font-size:0.82rem}
.proj-scenario:last-child{border-bottom:none}
.proj-scenario-label{color:var(--muted)}
.proj-val-up{color:var(--green)}
.proj-val-down{color:var(--red)}
.proj-val-neu{color:var(--accent)}
.peers-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.peer-item{display:flex;align-items:center;justify-content:space-between;padding:0.75rem 0;border-bottom:1px solid var(--border);font-size:0.875rem}
.peer-item:last-child{border-bottom:none}
.peer-ticker{font-weight:500}
.peer-name{font-size:0.75rem;color:var(--muted)}
.peer-perf.up{color:var(--green)}
.peer-perf.down{color:var(--red)}
.news-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.news-item{padding:0.85rem 0;border-bottom:1px solid var(--border)}
.news-item:last-child{border-bottom:none}
.news-source{font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--accent);margin-bottom:0.25rem}
.news-title{font-size:0.875rem;font-weight:500;margin-bottom:0.25rem}
.news-summary{font-size:0.78rem;color:var(--muted);line-height:1.5}
.sim-section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
.sim-row{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
.form-group{display:flex;flex-direction:column;gap:0.4rem;flex:1;min-width:160px}
.form-label{font-size:0.75rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted)}
.form-input{padding:0.65rem 0.9rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;transition:border-color 0.2s}
.form-input:focus{border-color:var(--accent-border)}
.form-select{padding:0.65rem 0.9rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;outline:none;cursor:pointer}
.allocation-list{display:flex;flex-direction:column;gap:0.75rem;margin-bottom:1rem}
.allocation-item{display:flex;align-items:center;gap:1rem;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:0.75rem 1rem}
.alloc-ticker{font-weight:500;font-size:0.9rem;width:60px}
.alloc-slider{flex:1;accent-color:var(--accent)}
.alloc-pct{width:40px;text-align:right;font-size:0.85rem;color:var(--accent)}
.alloc-remove{color:var(--muted);cursor:pointer;font-size:1.1rem;transition:color 0.2s}
.alloc-remove:hover{color:var(--red)}
.sim-results{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-top:1.5rem}
.sim-result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:1rem;margin-bottom:1.5rem}
.sim-result-item{text-align:center}
.sri-label{font-size:0.7rem;letter-spacing:0.08em;text-transform:uppercase;color:var(--muted);margin-bottom:0.3rem}
.sri-value{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:600}
.sri-value.up{color:var(--green)}
.sri-value.down{color:var(--red)}
.ops-table{width:100%;border-collapse:collapse;margin-bottom:1rem}
.ops-table th{font-size:0.72rem;letter-spacing:0.06em;text-transform:uppercase;color:var(--muted);padding:0.5rem 0.75rem;text-align:left;border-bottom:1px solid var(--border)}
.ops-table td{padding:0.6rem 0.75rem;font-size:0.85rem;border-bottom:1px solid rgba(30,37,48,0.5)}
.ops-table td select,.ops-table td input{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:0.35rem 0.5rem;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;width:100%}
.ops-table .remove-op{color:var(--muted);cursor:pointer;font-size:1rem}
.ops-table .remove-op:hover{color:var(--red)}
.history-list{display:flex;flex-direction:column;gap:0.75rem}
.history-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.25rem;display:flex;align-items:center;justify-content:space-between;cursor:pointer;transition:border-color 0.2s}
.history-item:hover{border-color:var(--accent-border)}
.hi-ticker{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:600}
.hi-name{font-size:0.8rem;color:var(--muted)}
.hi-date{font-size:0.72rem;color:var(--muted)}
.hi-score{background:var(--accent-dim);border:1px solid var(--accent-border);border-radius:6px;padding:0.3rem 0.6rem;font-size:0.8rem;color:var(--accent)}
.loading-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;gap:1.5rem}
.loading-spinner{width:48px;height:48px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-steps{display:flex;flex-direction:column;gap:0.5rem;text-align:center}
.loading-step{font-size:0.85rem;color:var(--muted);opacity:0;transition:opacity 0.4s}
.loading-step.visible{opacity:1}
.loading-step.done{color:var(--green)}
.waking-msg{font-size:0.8rem;color:var(--accent);opacity:0;transition:opacity 0.5s;margin-top:0.25rem}
.waking-msg.visible{opacity:1}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
.modal-title{font-family:'Playfair Display',serif;font-size:1.4rem;margin-bottom:0.5rem}
.modal-sub{font-size:0.875rem;color:var(--muted);margin-bottom:1.75rem}
.plans-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.75rem;margin-bottom:1.5rem}
@media(max-width:500px){.plans-grid{grid-template-columns:1fr}}
.plan-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:1.25rem;text-align:center}
.plan-card.featured{border-color:var(--accent)}
.plan-card-name{font-size:0.7rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);margin-bottom:0.4rem}
.plan-card-price{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:0.1rem}
.plan-card-price span{font-size:0.75rem;font-family:'DM Sans',sans-serif;color:var(--muted)}
.plan-card-features{text-align:left;margin-top:0.75rem;display:flex;flex-direction:column;gap:0.35rem}
.pcf{font-size:0.75rem;color:var(--muted);display:flex;align-items:flex-start;gap:0.4rem}
.pcf::before{content:'‚úì';color:var(--green);flex-shrink:0}
.pcf.locked::before{content:'‚úó';color:var(--border)}
.pcf.locked{opacity:0.5}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1.5rem}
.tab{padding:0.65rem 1.25rem;font-size:0.85rem;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.2s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.section-label{font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--accent);margin-bottom:0.5rem}
.page-header{margin-bottom:1.75rem}
.page-header h1{font-family:'Playfair Display',serif;font-size:1.6rem}
.page-header p{color:var(--muted);font-size:0.875rem;margin-top:0.25rem}
.toast{position:fixed;bottom:2rem;right:2rem;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:0.85rem 1.25rem;font-size:0.875rem;z-index:300;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:rgba(76,175,130,0.4);color:var(--green)}
.toast.error{border-color:rgba(224,90,90,0.4);color:var(--red)}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .topbar{padding:1rem}
  .page{padding:1rem}
  .analysis-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-text">Inver<span>so</span></div>
    <div class="logo-sub">An√°lisis con IA</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Principal</div>
    <a class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard"><span class="nav-icon">‚¨õ</span> Dashboard</a>
    <a class="nav-item" onclick="showPage('historial')" id="nav-historial"><span class="nav-icon">üïê</span> Historial</a>
    <div class="nav-section-label" style="margin-top:0.75rem">Herramientas</div>
    <a class="nav-item" onclick="showPage('simulador')" id="nav-simulador">
      <span class="nav-icon">üìä</span> Simulador
      <span style="margin-left:auto;font-size:0.6rem;background:var(--accent-dim);border:1px solid var(--accent-border);color:var(--accent);padding:0.1rem 0.4rem;border-radius:4px">PRO</span>
    </a>
    <div class="nav-section-label" style="margin-top:0.75rem">Cuenta</div>
    <a class="nav-item" onclick="showUpgradeModal()"><span class="nav-icon">‚ö°</span> Actualizar plan</a>
  </nav>
  <div class="sidebar-bottom">
    <div class="plan-badge">
      <div class="plan-name">Plan Free</div>
      <div class="plan-analyses">2 de 3 an√°lisis usados</div>
    </div>
  </div>
</aside>

<div class="main">
  <header class="topbar">
    <div style="display:flex;align-items:center;gap:1rem">
      <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.2rem;display:none" id="menu-btn">‚ò∞</button>
      <span class="topbar-title" id="topbar-title">Dashboard</span>
    </div>
    <div style="display:flex;align-items:center;gap:1rem">
      <div class="avatar">EZ</div>
    </div>
  </header>

  <div class="page active" id="page-dashboard">
    <div class="search-hero">
      <p class="section-label">Mercado argentino</p>
      <h1>¬øQu√© activo quer√©s <em style="font-style:italic;color:var(--accent)">analizar?</em></h1>
      <p>Ingres√° un ticker o nombre de activo y obten√© un an√°lisis completo con IA</p>
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input class="search-input" id="searchInput" placeholder="Ej: GGAL, AL30, YPF..." autocomplete="off"
          oninput="handleSearch(this.value)"
          onkeydown="if(event.key==='Enter')runAnalysis()"/>
        <div class="search-suggestions" id="suggestions"></div>
      </div>
      <div class="quick-label">M√°s consultados hoy</div>
      <div class="quick-chips">
        <div class="chip" onclick="selectAsset('GGAL')">GGAL</div>
        <div class="chip" onclick="selectAsset('YPF')">YPF</div>
        <div class="chip" onclick="selectAsset('AL30')">AL30</div>
        <div class="chip" onclick="selectAsset('GD30')">GD30</div>
        <div class="chip" onclick="selectAsset('PAMP')">PAMP</div>
        <div class="chip" onclick="selectAsset('MEP')">D√≥lar MEP</div>
        <div class="chip" onclick="selectAsset('MELI')">MELI</div>
      </div>
    </div>
    <div class="market-grid">
      <div class="market-card"><div class="mc-label">D√≥lar MEP</div><div class="mc-value" id="mk-mep">‚Äî</div><div class="mc-change" id="mk-mep-ch">Cargando...</div></div>
      <div class="market-card"><div class="mc-label">Riesgo Pa√≠s</div><div class="mc-value" id="mk-riesgo">‚Äî</div><div class="mc-change up" id="mk-riesgo-ch">Puntos EMBI+</div></div>
      <div class="market-card"><div class="mc-label">Inflaci√≥n mensual</div><div class="mc-value" id="mk-inflacion">‚Äî</div><div class="mc-change up">Dato BCRA</div></div>
      <div class="market-card"><div class="mc-label">D√≥lar Oficial</div><div class="mc-value" id="mk-oficial">‚Äî</div><div class="mc-change up">BCRA</div></div>
    </div>
  </div>

  <div class="page" id="page-loading">
    <div class="loading-screen">
      <div class="loading-spinner"></div>
      <div class="loading-steps">
        <div class="loading-step" id="ls1">Conectando con el servidor...</div>
        <div class="loading-step" id="ls2">Obteniendo datos hist√≥ricos del activo...</div>
        <div class="loading-step" id="ls3">Analizando contexto macroecon√≥mico...</div>
        <div class="loading-step" id="ls4">Procesando con IA...</div>
        <div class="loading-step" id="ls5">Generando reporte...</div>
      </div>
      <div class="waking-msg" id="waking-msg">‚è≥ El servidor est√° despertando, esto puede tardar hasta 30 segundos la primera vez...</div>
    </div>
  </div>

  <div class="page" id="page-analysis">
    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1.25rem">
      <button class="btn btn-outline" style="padding:0.4rem 0.85rem;font-size:0.8rem" onclick="showPage('dashboard')">‚Üê Volver</button>
      <span class="section-label" style="margin:0">An√°lisis b√°sico</span>
    </div>
    <div class="analysis-header">
      <div>
        <div class="ah-ticker" id="an-ticker">‚Äî</div>
        <div class="ah-name" id="an-name">‚Äî</div>
      </div>
      <div style="text-align:right">
        <div class="ah-price" id="an-price">‚Äî</div>
        <div class="ah-change" id="an-change">‚Äî</div>
      </div>
    </div>
    <div class="analysis-grid">
      <div class="score-card">
        <p class="score-label-text">Score de oportunidad</p>
        <div class="score-ring">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke="#1e2530" stroke-width="8"/>
            <circle id="scoreCircle" cx="60" cy="60" r="52" fill="none" stroke="#c9a96e" stroke-width="8"
              stroke-linecap="round" stroke-dasharray="326.7" stroke-dashoffset="326.7"/>
          </svg>
          <div class="score-center">
            <div class="score-num" id="an-score">‚Äî</div>
            <div class="score-den">/10</div>
          </div>
        </div>
        <p class="score-desc" id="an-score-desc">‚Äî</p>
      </div>
      <div class="factors-card">
        <div class="factors-title">Factores clave</div>
        <div id="factors-list"><p style="color:var(--muted);font-size:0.85rem">Cargando factores...</p></div>
      </div>
    </div>
    <div class="mep-card">
      <div class="card-title">Comparaci√≥n con D√≥lar MEP</div>
      <table class="mep-table">
        <thead><tr><th>Per√≠odo</th><th id="an-ticker-col">Activo</th><th>D√≥lar MEP</th><th>Diferencia</th></tr></thead>
        <tbody id="mep-tbody"><tr><td colspan="4" style="text-align:center;color:var(--muted);padding:1rem">Cargando...</td></tr></tbody>
      </table>
    </div>
    <div class="summary-card">
      <div class="card-title" style="margin-bottom:0.75rem">S√≠ntesis</div>
      <p id="an-summary" style="font-size:0.9rem;color:var(--muted);line-height:1.7">‚Äî</p>
    </div>
    <div class="btn-row">
      <button class="btn btn-accent" onclick="runDeepAnalysis()">Ver an√°lisis profundo ‚ö°</button>
      <button class="btn btn-outline" onclick="saveToHistory()">Guardar en historial</button>
      <button class="btn btn-outline" onclick="showPage('dashboard')">Nuevo an√°lisis</button>
    </div>
  </div>

  <div class="page" id="page-deep">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.25rem">
      <div style="display:flex;align-items:center;gap:0.75rem">
        <button class="btn btn-outline" style="padding:0.4rem 0.85rem;font-size:0.8rem" onclick="showPage('analysis')">‚Üê B√°sico</button>
        <span class="section-label" style="margin:0">An√°lisis profundo</span>
      </div>
      <button class="btn btn-accent" onclick="exportPDF()">Exportar PDF ‚Üì</button>
    </div>
    <div class="analysis-header">
      <div>
        <div class="ah-ticker" id="deep-ticker">‚Äî</div>
        <div class="ah-name" id="deep-name">‚Äî</div>
      </div>
      <div style="text-align:right">
        <div class="ah-price" id="deep-price">‚Äî</div>
        <div class="ah-change" id="deep-change">‚Äî</div>
      </div>
    </div>
    <div class="chart-card">
      <div class="card-title">Evoluci√≥n hist√≥rica ‚Äî √∫ltimos 12 meses</div>
      <div class="chart-wrapper"><canvas id="priceChart"></canvas></div>
    </div>
    <div class="projections-grid" id="projections-grid"></div>
    <div class="peers-card">
      <div class="card-title">Comparaci√≥n con activos similares (90 d√≠as)</div>
      <div id="peers-list"></div>
    </div>
    <div class="peers-card">
      <div class="card-title">Noticias recientes</div>
      <div id="news-list"></div>
    </div>
    <div class="summary-card">
      <div class="card-title" style="margin-bottom:0.75rem">S√≠ntesis t√©cnica</div>
      <p id="deep-technical" style="font-size:0.9rem;color:var(--muted);line-height:1.7">‚Äî</p>
    </div>
    <div class="btn-row">
      <button class="btn btn-accent" onclick="exportPDF()">Exportar PDF</button>
      <button class="btn btn-outline" onclick="saveToHistory()">Guardar en historial</button>
      <button class="btn btn-outline" onclick="showPage('dashboard')">Nuevo an√°lisis</button>
    </div>
  </div>

  <div class="page" id="page-simulador">
    <div class="page-header">
      <p class="section-label">Herramientas Pro</p>
      <h1>Simulador de cartera</h1>
      <p>Simul√° carteras con datos hist√≥ricos reales del mercado argentino</p>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="switchSimTab('fixed',this)">Cartera fija</div>
      <div class="tab" onclick="switchSimTab('dynamic',this)">Cartera din√°mica</div>
    </div>
    <div id="sim-fixed">
      <div class="sim-section">
        <div class="section-label">Configuraci√≥n</div>
        <div class="sim-row">
          <div class="form-group"><label class="form-label">Monto inicial</label><input class="form-input" type="number" id="sim-amount" value="100000"/></div>
          <div class="form-group"><label class="form-label">Moneda</label><select class="form-select" id="sim-currency"><option value="ars">Pesos (ARS)</option><option value="usd">D√≥lares (USD)</option></select></div>
          <div class="form-group"><label class="form-label">Fecha de inicio</label><input class="form-input" type="date" id="sim-date" value="2024-01-01"/></div>
        </div>
        <div class="section-label" style="margin-top:1rem">Composici√≥n</div>
        <div class="allocation-list" id="allocation-list">
          <div class="allocation-item"><span class="alloc-ticker">GGAL</span><input type="range" class="alloc-slider" min="0" max="100" value="40" oninput="updateAlloc(this)"/><span class="alloc-pct">40%</span><span class="alloc-remove" onclick="removeAlloc(this)">‚úï</span></div>
          <div class="allocation-item"><span class="alloc-ticker">AL30</span><input type="range" class="alloc-slider" min="0" max="100" value="35" oninput="updateAlloc(this)"/><span class="alloc-pct">35%</span><span class="alloc-remove" onclick="removeAlloc(this)">‚úï</span></div>
          <div class="allocation-item"><span class="alloc-ticker">MEP</span><input type="range" class="alloc-slider" min="0" max="100" value="25" oninput="updateAlloc(this)"/><span class="alloc-pct">25%</span><span class="alloc-remove" onclick="removeAlloc(this)">‚úï</span></div>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:0.75rem;flex-wrap:wrap">
          <button class="btn btn-outline" style="font-size:0.8rem" onclick="addAsset()">+ Agregar activo</button>
          <button class="btn btn-accent" onclick="runSimulation()">Simular ‚Üí</button>
        </div>
      </div>
      <div class="sim-results" id="sim-results" style="display:none">
        <div class="section-label">Resultado</div>
        <div class="sim-result-grid" id="sim-result-grid"></div>
        <div class="chart-wrapper" style="height:220px"><canvas id="simChart"></canvas></div>
      </div>
    </div>
    <div id="sim-dynamic" style="display:none">
      <div class="sim-section">
        <div class="section-label">Registrar operaciones</div>
        <div style="overflow-x:auto">
          <table class="ops-table">
            <thead><tr><th>Tipo</th><th>Activo</th><th>Cantidad</th><th>Precio</th><th>Fecha</th><th></th></tr></thead>
            <tbody id="ops-body">
              <tr><td><select><option>Compra</option><option>Venta</option></select></td><td><input type="text" value="GGAL"/></td><td><input type="number" value="100"/></td><td><input type="number" value="5800"/></td><td><input type="date" value="2024-03-15"/></td><td><span class="remove-op" onclick="removeOp(this)">‚úï</span></td></tr>
            </tbody>
          </table>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:0.75rem">
          <button class="btn btn-outline" style="font-size:0.8rem" onclick="addOp()">+ Agregar operaci√≥n</button>
          <button class="btn btn-accent" onclick="runDynamic()">Calcular ‚Üí</button>
        </div>
      </div>
      <div class="sim-results" id="dyn-results" style="display:none">
        <div class="section-label">Resultado</div>
        <div class="sim-result-grid" id="dyn-result-grid"></div>
        <div id="dyn-positions" style="margin-top:1rem"></div>
      </div>
    </div>
  </div>

  <div class="page" id="page-historial">
    <div class="page-header">
      <p class="section-label">Tus an√°lisis</p>
      <h1>Historial</h1>
      <p>Revis√° y actualiz√° tus an√°lisis anteriores</p>
    </div>
    <div class="history-list" id="history-list">
      <div style="text-align:center;padding:3rem;color:var(--muted)">
        <div style="font-size:2.5rem;margin-bottom:0.75rem;opacity:0.3">üïê</div>
        <p>Tus an√°lisis guardados aparecer√°n ac√°</p>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="upgradeModal">
  <div class="modal">
    <div class="modal-title">Actualiz√° tu plan</div>
    <div class="modal-sub">Esta funci√≥n est√° disponible en los planes Basic y Pro.</div>
    <div class="plans-grid">
      <div class="plan-card">
        <div class="plan-card-name">Free</div>
        <div class="plan-card-price">$0<span>/mes</span></div>
        <div class="plan-card-features">
          <div class="pcf">3 an√°lisis b√°sicos</div>
          <div class="pcf locked">Sin historial</div>
          <div class="pcf locked">Sin simulador</div>
          <div class="pcf locked">Sin PDF</div>
        </div>
      </div>
      <div class="plan-card">
        <div class="plan-card-name">Basic</div>
        <div class="plan-card-price">$7.99<span>/mes</span></div>
        <div class="plan-card-features">
          <div class="pcf">An√°lisis ilimitados</div>
          <div class="pcf">Historial</div>
          <div class="pcf locked">Sin simulador</div>
          <div class="pcf locked">Sin PDF</div>
        </div>
        <button class="btn btn-outline" style="width:100%;margin-top:1rem;font-size:0.8rem">Elegir Basic</button>
      </div>
      <div class="plan-card featured">
        <div class="plan-card-name">Pro</div>
        <div class="plan-card-price">$17.99<span>/mes</span></div>
        <div class="plan-card-features">
          <div class="pcf">Todo lo de Basic</div>
          <div class="pcf">An√°lisis profundo</div>
          <div class="pcf">Simulador</div>
          <div class="pcf">PDF</div>
        </div>
        <button class="btn btn-accent" style="width:100%;margin-top:1rem;font-size:0.8rem">Elegir Pro ‚ö°</button>
      </div>
    </div>
    <button class="btn btn-outline" style="width:100%;font-size:0.85rem" onclick="closeModal()">Continuar con Free</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIGURACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API = "https://inverso-backend-12yw.onrender.com";

const SUGGESTIONS = [
  {ticker:'GGAL', name:'Grupo Financiero Galicia'},
  {ticker:'YPF',  name:'YPF S.A.'},
  {ticker:'AL30', name:'Bono Soberano 2030'},
  {ticker:'GD30', name:'Bono Global 2030'},
  {ticker:'PAMP', name:'Pampa Energ√≠a'},
  {ticker:'MEP',  name:'D√≥lar MEP'},
  {ticker:'MELI', name:'MercadoLibre CEDEAR'},
  {ticker:'BMA',  name:'Banco Macro'},
  {ticker:'VIST', name:'Vista Energy'},
];

let currentTicker  = '';
let lastBasicData  = null;
let priceChartInst = null;
let simChartInst   = null;
let analysisHistory = JSON.parse(localStorage.getItem('inverso_history') || '[]');

// ‚îÄ‚îÄ‚îÄ NAVEGACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const nav = document.getElementById('nav-' + page);
  if (nav) nav.classList.add('active');
  const titles = {dashboard:'Dashboard',analysis:'An√°lisis b√°sico',deep:'An√°lisis profundo',simulador:'Simulador',historial:'Historial',loading:'Analizando...'};
  document.getElementById('topbar-title').textContent = titles[page] || 'Inverso';
  window.scrollTo(0, 0);
}

// ‚îÄ‚îÄ‚îÄ B√öSQUEDA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleSearch(val) {
  const box = document.getElementById('suggestions');
  if (!val) { box.classList.remove('open'); return; }
  const filtered = SUGGESTIONS.filter(a =>
    a.ticker.toLowerCase().includes(val.toLowerCase()) ||
    a.name.toLowerCase().includes(val.toLowerCase())
  );
  if (!filtered.length) { box.classList.remove('open'); return; }
  box.innerHTML = filtered.map(a => `
    <div class="suggestion-item" onclick="selectAsset('${a.ticker}')">
      <div><div class="sug-ticker">${a.ticker}</div><div class="sug-name">${a.name}</div></div>
    </div>`).join('');
  box.classList.add('open');
}

function selectAsset(ticker) {
  document.getElementById('searchInput').value = ticker;
  document.getElementById('suggestions').classList.remove('open');
  currentTicker = ticker;
  runAnalysis();
}

// ‚îÄ‚îÄ‚îÄ AN√ÅLISIS B√ÅSICO ‚îÄ‚îÄ POST correcto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runAnalysis() {
  const ticker = (document.getElementById('searchInput').value || currentTicker).trim().toUpperCase();
  if (!ticker) return;
  currentTicker = ticker;

  showPage('loading');
  startLoadingAnim();

  // Aviso de "despertando" si tarda m√°s de 6 segundos
  const wakingTimer = setTimeout(() => {
    document.getElementById('waking-msg').classList.add('visible');
  }, 6000);

  try {
    const res = await fetchWithRetry(`${API}/analyze/basic`, {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ ticker, plan: 'free' })
    });

    clearTimeout(wakingTimer);
    document.getElementById('waking-msg').classList.remove('visible');

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Error ${res.status}`);
    }

    lastBasicData = await res.json();
    populateBasic(lastBasicData);
    showPage('analysis');

  } catch (err) {
    clearTimeout(wakingTimer);
    document.getElementById('waking-msg').classList.remove('visible');
    console.error(err);
    showPage('dashboard');
    showToast('Error: ' + err.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ AN√ÅLISIS PROFUNDO ‚îÄ‚îÄ POST correcto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runDeepAnalysis() {
  if (!currentTicker) return;

  showPage('loading');
  startLoadingAnim();

  const wakingTimer = setTimeout(() => {
    document.getElementById('waking-msg').classList.add('visible');
  }, 6000);

  try {
    const res = await fetchWithRetry(`${API}/analyze/deep`, {
      method:  'POST',
      headers: {'Content-Type': 'application/json'},
      body:    JSON.stringify({ ticker: currentTicker, plan: 'pro' })
    });

    clearTimeout(wakingTimer);
    document.getElementById('waking-msg').classList.remove('visible');

    if (!res.ok) throw new Error(`Error ${res.status}`);

    const data = await res.json();
    populateDeep(data);
    showPage('deep');

  } catch (err) {
    clearTimeout(wakingTimer);
    document.getElementById('waking-msg').classList.remove('visible');
    showPage('analysis');
    showToast('Error al cargar an√°lisis profundo: ' + err.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ FETCH CON REINTENTOS (maneja "waking up" de Render) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchWithRetry(url, options, retries = 3, timeout = 90000) {
  for (let i = 0; i < retries; i++) {
    try {
      const ctrl  = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), timeout);
      const res   = await fetch(url, { ...options, signal: ctrl.signal });
      clearTimeout(timer);
      return res;
    } catch (err) {
      if (i === retries - 1) throw err;
      await new Promise(r => setTimeout(r, 3000));
    }
  }
}

// ‚îÄ‚îÄ‚îÄ ANIMACI√ìN DE CARGA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startLoadingAnim() {
  const steps = ['ls1','ls2','ls3','ls4','ls5'];
  steps.forEach(s => document.getElementById(s).classList.remove('visible','done'));
  let i = 0;
  const iv = setInterval(() => {
    if (i < steps.length) {
      if (i > 0) document.getElementById(steps[i-1]).classList.add('done');
      document.getElementById(steps[i]).classList.add('visible');
      i++;
    } else { clearInterval(iv); }
  }, 900);
}

// ‚îÄ‚îÄ‚îÄ POBLAR AN√ÅLISIS B√ÅSICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateBasic(data) {
  // Header
  document.getElementById('an-ticker').textContent     = data.ticker || '‚Äî';
  document.getElementById('an-ticker-col').textContent = data.ticker || '‚Äî';
  document.getElementById('an-name').textContent       = data.name   || '‚Äî';

  const price  = data.price ?? data.current_price ?? 0;
  const change = data.change_pct ?? data.change_percent ?? 0;
  document.getElementById('an-price').textContent = '$' + Number(price).toLocaleString('es-AR', {maximumFractionDigits:2});
  const chEl = document.getElementById('an-change');
  chEl.textContent = (change >= 0 ? '‚Üë +' : '‚Üì ') + Math.abs(change).toFixed(2) + '% hoy';
  chEl.className   = 'ah-change ' + (change >= 0 ? 'up' : 'down');

  // Score
  const score = parseFloat(data.score) || 0;
  document.getElementById('an-score').textContent      = score.toFixed(1);
  document.getElementById('an-score-desc').textContent = data.score_description || '';
  document.getElementById('scoreCircle').style.strokeDashoffset = 326.7 * (1 - score / 10);

  // Factores
  const fl = document.getElementById('factors-list');
  fl.innerHTML = (data.factors || []).map(f => {
    const dot = f.type === 'positive' ? 'pos' : f.type === 'negative' ? 'neg' : 'neu';
    return `<div class="factor-item">
      <div class="factor-dot ${dot}"></div>
      <div>
        <div class="factor-name">${f.title}</div>
        <div class="factor-desc">${f.description}</div>
      </div>
    </div>`;
  }).join('') || '<p style="color:var(--muted);font-size:0.85rem">Sin factores disponibles</p>';

  // Tabla MEP
  const mep = data.mep_comparison || {};
  document.getElementById('mep-tbody').innerHTML = [
    {label:'30 d√≠as',  a: mep.days_30  ?? 0, m: mep.mep_30  ?? 0},
    {label:'90 d√≠as',  a: mep.days_90  ?? 0, m: mep.mep_90  ?? 0},
    {label:'365 d√≠as', a: mep.days_365 ?? 0, m: mep.mep_365 ?? 0},
  ].map(p => {
    const diff = (p.a - p.m).toFixed(1);
    return `<tr>
      <td>${p.label}</td>
      <td class="${p.a >= 0 ? 'pos-val':'neg-val'}">${p.a >= 0 ? '+':''}${p.a}%</td>
      <td>${p.m >= 0 ? '+':''}${p.m}%</td>
      <td class="${parseFloat(diff) >= 0 ? 'pos-val':'neg-val'}">${parseFloat(diff) >= 0 ? '+':''}${diff}%</td>
    </tr>`;
  }).join('');

  // Resumen
  document.getElementById('an-summary').textContent = data.summary || '‚Äî';
}

// ‚îÄ‚îÄ‚îÄ POBLAR AN√ÅLISIS PROFUNDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateDeep(data) {
  document.getElementById('deep-ticker').textContent = data.ticker || '‚Äî';
  document.getElementById('deep-name').textContent   = data.name   || '‚Äî';

  const price  = data.price ?? data.current_price ?? 0;
  const change = data.change_pct ?? data.change_percent ?? 0;
  document.getElementById('deep-price').textContent = '$' + Number(price).toLocaleString('es-AR', {maximumFractionDigits:2});
  const dch = document.getElementById('deep-change');
  dch.textContent = (change >= 0 ? '‚Üë +' : '‚Üì ') + Math.abs(change).toFixed(2) + '% hoy';
  dch.className   = 'ah-change ' + (change >= 0 ? 'up' : 'down');

  // Gr√°fico hist√≥rico
  const history = data.history || data.price_history || [];
  if (history.length > 0) {
    renderPriceChart(
      history.map(h => (h.date || '').slice(5)),
      history.map(h => h.price ?? h.close ?? 0)
    );
  }

  // Proyecciones
  const proj = data.projections || {};
  document.getElementById('projections-grid').innerHTML =
    [{key:'months_3',label:'3 meses'},{key:'months_6',label:'6 meses'},{key:'months_12',label:'12 meses'}]
    .map(p => {
      const s = proj[p.key] || {};
      return `<div class="proj-card">
        <div class="proj-horizon">${p.label}</div>
        <div class="proj-scenario"><span class="proj-scenario-label">Optimista</span><span class="proj-val-up">${s.optimistic||'‚Äî'}</span></div>
        <div class="proj-scenario"><span class="proj-scenario-label">Neutro</span><span class="proj-val-neu">${s.neutral||'‚Äî'}</span></div>
        <div class="proj-scenario"><span class="proj-scenario-label">Pesimista</span><span class="proj-val-down">${s.pessimistic||'‚Äî'}</span></div>
      </div>`;
    }).join('');

  // Pares
  document.getElementById('peers-list').innerHTML =
    (data.peers || []).map(p => `
      <div class="peer-item">
        <div><div class="peer-ticker">${p.ticker}</div><div class="peer-name">${p.name}</div></div>
        <div class="peer-perf ${p.performance_90d >= 0 ? 'up':'down'}">${p.performance_90d >= 0 ? '+':''}${p.performance_90d}%</div>
      </div>`).join('') || '<p style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0">Sin datos de pares</p>';

  // Noticias
  document.getElementById('news-list').innerHTML =
    (data.news || []).map(n => `
      <div class="news-item">
        <div class="news-source">${n.source} ¬∑ ${n.date}</div>
        <div class="news-title">${n.title}</div>
        <div class="news-summary">${n.summary}</div>
      </div>`).join('') || '<p style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0">Sin noticias disponibles</p>';

  // S√≠ntesis t√©cnica
  document.getElementById('deep-technical').textContent = data.technical_summary || data.summary || '‚Äî';
}

// ‚îÄ‚îÄ‚îÄ GR√ÅFICO DE PRECIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPriceChart(labels, prices) {
  const ctx = document.getElementById('priceChart');
  if (!ctx) return;
  if (priceChartInst) priceChartInst.destroy();
  priceChartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: prices,
        borderColor: '#c9a96e',
        backgroundColor: 'rgba(201,169,110,0.08)',
        borderWidth: 2,
        pointRadius: 0,
        pointHoverRadius: 4,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {legend:{display:false}, tooltip:{mode:'index',intersect:false,backgroundColor:'#13171f',borderColor:'#1e2530',borderWidth:1,titleColor:'#e8e4dc',bodyColor:'#7a8394'}},
      scales: {
        x: {grid:{color:'rgba(30,37,48,0.5)'}, ticks:{color:'#7a8394',font:{size:10},maxTicksLimit:10}},
        y: {grid:{color:'rgba(30,37,48,0.5)'}, ticks:{color:'#7a8394',font:{size:10},callback:v=>'$'+Number(v).toLocaleString()}}
      }
    }
  });
}

// ‚îÄ‚îÄ‚îÄ MARKET OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMarketOverview() {
  try {
    const res  = await fetch(`${API}/assets/market-overview`);
    if (!res.ok) return;
    const data = await res.json();
    if (data.mep?.price) {
      document.getElementById('mk-mep').textContent = '$' + Number(data.mep.price).toLocaleString('es-AR',{maximumFractionDigits:0});
      const ch = data.mep.change_pct || 0;
      const el = document.getElementById('mk-mep-ch');
      el.textContent = (ch >= 0 ? '‚Üë +' : '‚Üì ') + Math.abs(ch).toFixed(1) + '% hoy';
      el.className   = 'mc-change ' + (ch >= 0 ? 'up' : 'down');
    }
    if (data.riesgo_pais) document.getElementById('mk-riesgo').textContent  = data.riesgo_pais;
    if (data.inflacion)   document.getElementById('mk-inflacion').textContent = data.inflacion + '%';
    if (data.usd_oficial) document.getElementById('mk-oficial').textContent  = '$' + Number(data.usd_oficial).toLocaleString('es-AR',{maximumFractionDigits:0});
  } catch(e) { /* silencioso */ }
}

// ‚îÄ‚îÄ‚îÄ SIMULADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchSimTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('sim-fixed').style.display   = tab === 'fixed'   ? 'block' : 'none';
  document.getElementById('sim-dynamic').style.display = tab === 'dynamic' ? 'block' : 'none';
}

function updateAlloc(slider) { slider.nextElementSibling.textContent = slider.value + '%'; }
function removeAlloc(btn)    { btn.closest('.allocation-item').remove(); }

function addAsset() {
  const list = document.getElementById('allocation-list');
  const item = document.createElement('div');
  item.className = 'allocation-item';
  item.innerHTML = `<span class="alloc-ticker">YPF</span><input type="range" class="alloc-slider" min="0" max="100" value="20" oninput="updateAlloc(this)"/><span class="alloc-pct">20%</span><span class="alloc-remove" onclick="removeAlloc(this)">‚úï</span>`;
  list.appendChild(item);
}

async function runSimulation() {
  const amount    = parseFloat(document.getElementById('sim-amount').value) || 100000;
  const currency  = document.getElementById('sim-currency').value;
  const startDate = document.getElementById('sim-date').value;
  const allocations = Array.from(document.querySelectorAll('#allocation-list .allocation-item')).map(el => ({
    ticker:     el.querySelector('.alloc-ticker').textContent,
    percentage: parseFloat(el.querySelector('.alloc-slider').value)
  }));

  showToast('Calculando simulaci√≥n...', '');
  try {
    const res = await fetch(`${API}/portfolio/fixed`, {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({amount, currency, start_date: startDate, allocations})
    });
    if (!res.ok) throw new Error('Error en simulaci√≥n');
    const data = await res.json();
    displaySimResults(data);
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

function displaySimResults(data) {
  const results = document.getElementById('sim-results');
  results.style.display = 'block';
  const ret = data.total_return_pct || 0;
  document.getElementById('sim-result-grid').innerHTML = `
    <div class="sim-result-item"><div class="sri-label">Inversi√≥n inicial</div><div class="sri-value" style="color:var(--text)">$${Number(data.initial_amount).toLocaleString()}</div></div>
    <div class="sim-result-item"><div class="sri-label">Valor actual</div><div class="sri-value ${ret>=0?'up':'down'}">$${Number(data.current_value).toLocaleString()}</div></div>
    <div class="sim-result-item"><div class="sri-label">Rendimiento</div><div class="sri-value ${ret>=0?'up':'down'}">${ret>=0?'+':''}${ret}%</div></div>
    <div class="sim-result-item"><div class="sri-label">vs Inflaci√≥n</div><div class="sri-value ${data.vs_inflation_pct>=0?'up':'down'}">${data.vs_inflation_pct>=0?'+':''}${data.vs_inflation_pct}%</div></div>
    <div class="sim-result-item"><div class="sri-label">vs MEP</div><div class="sri-value ${data.vs_mep_pct>=0?'up':'down'}">${data.vs_mep_pct>=0?'+':''}${data.vs_mep_pct}%</div></div>`;
  results.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(() => {
    const ctx = document.getElementById('simChart');
    if (!ctx) return;
    if (simChartInst) simChartInst.destroy();
    const hist = data.history || [];
    simChartInst = new Chart(ctx, {
      type:'line',
      data:{labels:hist.map(h=>(h.date||'').slice(5)),datasets:[{label:'Cartera',data:hist.map(h=>h.value),borderColor:'#c9a96e',backgroundColor:'rgba(201,169,110,0.06)',borderWidth:2,pointRadius:0,fill:true,tension:0.4}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(30,37,48,0.5)'},ticks:{color:'#7a8394',font:{size:10},maxTicksLimit:10}},y:{grid:{color:'rgba(30,37,48,0.5)'},ticks:{color:'#7a8394',font:{size:10},callback:v=>'$'+Math.round(v/1000)+'k'}}}}
    });
  }, 100);
}

async function runDynamic() {
  const rows = document.querySelectorAll('#ops-body tr');
  const operations = Array.from(rows).map(row => {
    const cells = row.querySelectorAll('td');
    return {
      type:     cells[0].querySelector('select').value === 'Compra' ? 'buy' : 'sell',
      ticker:   cells[1].querySelector('input').value.toUpperCase(),
      quantity: parseFloat(cells[2].querySelector('input').value) || 0,
      price:    parseFloat(cells[3].querySelector('input').value) || 0,
      date:     cells[4].querySelector('input').value,
    };
  }).filter(op => op.ticker && op.quantity > 0 && op.price > 0 && op.date);

  try {
    const res = await fetch(`${API}/portfolio/dynamic`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({operations, currency:'ars'})
    });
    if (!res.ok) throw new Error('Error');
    const data = await res.json();
    const results = document.getElementById('dyn-results');
    results.style.display = 'block';
    const ret = data.return_pct || 0;
    document.getElementById('dyn-result-grid').innerHTML = `
      <div class="sim-result-item"><div class="sri-label">Capital invertido</div><div class="sri-value" style="color:var(--text)">$${Number(data.invested_capital).toLocaleString()}</div></div>
      <div class="sim-result-item"><div class="sri-label">Valuaci√≥n actual</div><div class="sri-value ${ret>=0?'up':'down'}">$${Number(data.current_value).toLocaleString()}</div></div>
      <div class="sim-result-item"><div class="sri-label">Resultado</div><div class="sri-value ${ret>=0?'up':'down'}">${ret>=0?'+':''}$${Number(data.total_result).toLocaleString()}</div></div>
      <div class="sim-result-item"><div class="sri-label">Rendimiento</div><div class="sri-value ${ret>=0?'up':'down'}">${ret>=0?'+':''}${ret}%</div></div>`;
    document.getElementById('dyn-positions').innerHTML = '<div class="section-label">Posiciones actuales</div>' +
      (data.positions||[]).map(p=>`<div class="peer-item"><div><div class="peer-ticker">${p.ticker} (${p.quantity})</div><div class="peer-name">Precio promedio: $${p.avg_price}</div></div><div class="peer-perf ${p.gain_pct>=0?'up':'down'}">${p.gain_pct>=0?'+':''}${p.gain_pct}% ¬∑ $${Number(p.value).toLocaleString()}</div></div>`).join('');
    results.scrollIntoView({behavior:'smooth',block:'nearest'});
  } catch(e) { showToast('Error: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveToHistory() {
  if (!lastBasicData) return;
  const entry = {
    ticker: lastBasicData.ticker,
    name:   lastBasicData.name,
    score:  lastBasicData.score,
    date:   new Date().toLocaleString('es-AR'),
    data:   lastBasicData
  };
  analysisHistory.unshift(entry);
  if (analysisHistory.length > 20) analysisHistory.pop();
  localStorage.setItem('inverso_history', JSON.stringify(analysisHistory));
  renderHistory();
  showToast('Guardado en historial ‚úì', 'success');
}

function renderHistory() {
  const list = document.getElementById('history-list');
  if (!analysisHistory.length) {
    list.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--muted)"><div style="font-size:2.5rem;margin-bottom:0.75rem;opacity:0.3">üïê</div><p>Tus an√°lisis guardados aparecer√°n ac√°</p></div>';
    return;
  }
  list.innerHTML = analysisHistory.map((h, i) => `
    <div class="history-item" onclick="loadFromHistory(${i})">
      <div style="display:flex;align-items:center;gap:1rem">
        <div class="hi-ticker">${h.ticker}</div>
        <div><div class="hi-name">${h.name}</div><div class="hi-date">${h.date}</div></div>
      </div>
      <div class="hi-score">Score ${Number(h.score).toFixed(1)}</div>
    </div>`).join('');
}

function loadFromHistory(i) {
  lastBasicData = analysisHistory[i].data;
  currentTicker = analysisHistory[i].ticker;
  populateBasic(lastBasicData);
  showPage('analysis');
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showUpgradeModal() { document.getElementById('upgradeModal').classList.add('open'); }
function closeModal()       { document.getElementById('upgradeModal').classList.remove('open'); }
document.getElementById('upgradeModal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

function exportPDF() { showToast('PDF disponible en plan Pro', ''); }

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = 'toast show ' + (type || '');
  setTimeout(() => t.className = 'toast', 3500);
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function addOp() {
  const row = document.createElement('tr');
  row.innerHTML = `<td><select><option>Compra</option><option>Venta</option></select></td><td><input type="text" placeholder="Ticker"/></td><td><input type="number" placeholder="Cantidad"/></td><td><input type="number" placeholder="Precio"/></td><td><input type="date"/></td><td><span class="remove-op" onclick="removeOp(this)">‚úï</span></td>`;
  document.getElementById('ops-body').appendChild(row);
}
function removeOp(btn) { btn.closest('tr').remove(); }

function checkMobile() {
  document.getElementById('menu-btn').style.display = window.innerWidth <= 768 ? 'block' : 'none';
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('resize', checkMobile);
checkMobile();
renderHistory();
loadMarketOverview();
document.addEventListener('click', e => {
  if (!e.target.closest('.search-box')) document.getElementById('suggestions').classList.remove('open');
});
</script>
</body>
</html>
